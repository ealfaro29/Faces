<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Miss Universe Glamour Builder</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#050505; --panel:#0a0a0aef; --divider:#333; --text:#f0f0f0;
    /* Paleta Dorado Miss Universo (Ajustada para legibilidad) */
    --gold-1: #bf953f; --gold-2: #fcf6ba; --gold-3: #b38728; --gold-4: #fbf5b7; --gold-5: #aa771c;
    --silver-1: #bcc6cc; --silver-2: #eee; --silver-3: #999;
    --bronze-1: #cd7f32; --bronze-2: #eec7a3; --bronze-3: #8c5e2c;

    /* NUEVO: Dorados ultra claros para el fondo de las cards */
    --card-bg-1: #fffce6; /* Casi blanco dorado */
    --card-bg-2: #f7e8a4; /* Dorado pÃ¡lido */
    --card-text: #3d2b05; /* MarrÃ³n dorado muy oscuro para texto */

    --accent: var(--gold-1);
    --font-display: 'Cinzel', serif;
    --font-body: 'Playfair Display', serif;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:var(--font-body); overflow-x:hidden;}

  #p5-background { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.6; }

  .app{max-width:1600px; margin:20px auto 0; padding:0 20px 180px;} /* Ancho aumentado para la nueva columna */
  .topbar{text-align:center; margin-bottom:30px; padding: 20px; background: linear-gradient(to bottom, #0000, #000a); border-bottom: 1px solid #ffffff20;}
  .title{
    font-family: var(--font-display); font-weight:900; font-size:42px; letter-spacing:2px;
    background: linear-gradient(to right, var(--gold-1), var(--gold-2), var(--gold-3), var(--gold-4), var(--gold-5));
    -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0px 2px 10px #00000080;
    text-transform: uppercase; margin: 0;
  }
  .hint{color:#bbb; font-size:16px; font-family:var(--font-display); letter-spacing:1px; margin-top: 8px;}

  /* --- ACTUALIZADO: 5 columnas --- */
  .grid{display:grid; gap:20px; grid-template-columns:1fr 1fr 0.9fr 0.8fr 0.8fr}
  .col{background:var(--panel); border:1px solid #ffffff15; border-radius:4px; padding:15px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px #00000050;}
  .col h2{margin:0 0 15px 0; font-size:24px; color:var(--gold-2); text-align:center; font-family: var(--font-display); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--gold-5); padding-bottom: 10px;}

  .slots{min-height: 600px; display:grid; grid-template-rows: repeat(var(--rows), 1fr); gap:10px;}
  
  /* --- ACTUALIZADO: Media queries para 5 columnas --- */
  @media (max-width: 1200px){ 
    .grid{grid-template-columns:1fr 1fr 1fr; gap:15px} 
    .col:nth-child(4), .col:nth-child(5) { grid-column: span 1; } /* Los Ãºltimos 2 en una fila */
  }
  @media (max-width: 768px){ .grid{grid-template-columns:1fr} } /* Pasa a 1 columna */

  .slot{
    position:relative; display:flex; align-items:center; gap:15px;
    border:1px solid #ffffff10; background: #00000060;
    padding:4px 12px 4px 60px; min-height: 55px;
    transition: all .3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }
  .slot > * { pointer-events: none; }

  .slot .num{
    position:absolute; left:10px; font-family: var(--font-display);
    width:40px; height:100%; display:flex; align-items:center; justify-content:center;
    font-size:20px; font-weight:900; color:#ffffff40; border-right: 1px solid #ffffff10;
  }
  .slot .photo{
    width:44px; height:44px; border-radius:50%; border:2px solid var(--gold-1);
    overflow:hidden; display:none; background:#111; flex-shrink:0; box-shadow: 0 0 15px #000;
  }
  .slot .photo img{width:100%; height:100%; object-fit:cover}
  .slot .name {
    font-family: var(--font-display); font-size: 15px; letter-spacing: 1px;
    text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;
    color: #999; display: flex; align-items: center; gap: 10px;
  }
  .slot-flag { width: 24px; height: auto; border-radius: 2px; box-shadow: 0 2px 5px #000; }
  .slot[data-band="C"] .photo, .slot[data-band="D"] .photo{display:block}
  /* Ocultar foto para la nueva columna 'E' (Banca) */
  .slot[data-band="E"] .photo { display: none; }

  .slot.drag-hover { background: #ffffff10 !important; border-color: var(--gold-2) !important; transform: scale(1.03); z-index:10; }
  .slot.occupied { background: linear-gradient(to right, #111, #222); border-color: var(--gold-5); }
  .slot.occupied .name { color: #fff; font-weight: 700; }
  .slot.occupied .num { color: var(--gold-2); text-shadow: 0 0 10px var(--gold-5); }

  /* Estilos para la Banca (columna E) */
  .slot[data-band="E"].occupied { background: #1a1a1a; border-color: var(--divider); }
  .slot[data-band="E"].occupied .num { color: var(--silver-3); }
  .slot[data-band="E"] .num { font-size: 16px; }

  .slot[data-rank="3"].occupied { background: linear-gradient(135deg, var(--bronze-3), var(--bronze-1)); border: 1px solid var(--bronze-2); }
  .slot[data-rank="2"].occupied { background: linear-gradient(135deg, var(--silver-3), var(--silver-1)); border: 1px solid var(--silver-2); color: #000; }
  .slot[data-rank="1"] { min-height: 75px; }
  .slot[data-rank="1"].occupied {
    background: linear-gradient(135deg, var(--gold-5), var(--gold-1) 30%, var(--gold-2) 50%, var(--gold-1) 70%, var(--gold-3));
    border: 2px solid var(--gold-2); box-shadow: 0 0 30px var(--gold-5);
    animation: winner-pulse 4s infinite alternate;
  }
  .slot[data-rank="1"].occupied .name { color: #000; font-weight: 900; font-size: 22px; }
  .slot[data-rank="1"].occupied .num { color: #000; border-right-color: #00000030; font-size: 28px; }
  @keyframes winner-pulse { 0% { box-shadow: 0 0 20px var(--gold-5); } 100% { box-shadow: 0 0 50px var(--gold-2), inset 0 0 20px var(--gold-4); } }

  .pool{margin-top:30px; background:var(--panel); border:1px solid var(--gold-5); backdrop-filter: blur(10px); padding:25px; border-radius: 4px;}
  .pool h3{font-family: var(--font-display); color: var(--gold-2); font-size: 22px; margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 2px;}
  .pool.drag-hover { outline: 2px dashed var(--gold-2); background: #ffffff08; }
  
  /* --- NUEVO: Barra de BÃºsqueda --- */
  .pool-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
  .pool-header h3 { margin: 0; }
  #search-bar {
    background: #00000050; border: 1px solid var(--gold-5); border-radius: 3px;
    color: var(--text); padding: 10px 15px; font-family: var(--font-body);
    font-size: 16px; min-width: 300px;
  }
  #search-bar::placeholder { color: #999; }
  #search-bar:focus { background: #000; border-color: var(--gold-2); outline: none; }

  .cards{display:flex; flex-wrap:wrap; gap:10px}
  /* --- CARDS (POOL) MEJORADAS PARA LEGIBILIDAD --- */
  .card{
    /* Fondo mucho mÃ¡s claro y texto oscuro para alto contraste */
    background: linear-gradient(145deg, var(--card-bg-1) 10%, var(--card-bg-2) 90%);
    color: var(--card-text);
    font-family: var(--font-display); font-weight: 800; /* Negrita extra */
    font-size: 13px; letter-spacing: 0.5px;
    padding: 8px 14px; cursor: grab; user-select: none;
    border: 1px solid var(--gold-1); border-radius: 3px;
    box-shadow: 0 4px 8px #00000060;
    display: flex; align-items: center; gap: 8px;
    transition: all .15s ease-out;
  }
  .card:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 8px 20px #00000080;
    background: var(--card-bg-1); /* MÃ¡s brillante al hover */
  }
  .card:active{cursor:grabbing; transform:scale(0.98);}
  .card.ghost { opacity: 0.4; filter: grayscale(1) brightness(0.7); }
  .card-flag { width: 20px; height: 15px; object-fit: cover; border-radius: 2px; box-shadow: 0 1px 3px #00000040; }

  .foot{margin-top: 50px; display:flex; justify-content:center; padding: 0 20px;}
  .bar{background: #111; border:1px solid var(--gold-5); padding:15px 25px; display:flex; gap:15px; align-items:center; flex-wrap:wrap; box-shadow: 0 10px 40px #000; border-radius: 4px;}
  .btn{border:0; padding:12px 24px; font-family: var(--font-display); font-weight:700; letter-spacing: 1px; text-transform: uppercase; cursor:pointer; transition: all .2s; background: transparent; color: var(--gold-2); border: 1px solid var(--gold-5);}
  .btn:hover{ background: var(--gold-5); color: #000; box-shadow: 0 0 15px var(--gold-5); }
  .btn.primary{ background: linear-gradient(135deg, var(--gold-1), var(--gold-5)); color:#000; border:none; }
  .btn.primary:hover{ filter: brightness(1.2); }
  .sep{width:1px; height:30px; background:var(--divider); margin:0 10px}
  .status{font-family: var(--font-display); color:var(--gold-4); margin-left:15px}
</style>
</head>
<body>
<div id="p5-background"></div>
<div class="app">
  <div class="topbar">
    <h1 class="title">Miss Universe Official Top</h1>
    <div class="hint">Arrastra a tus favoritas hacia la corona</div>
  </div>
  <div class="grid">
    <section class="col"><h2>Top 30</h2><div id="col-A" class="slots" style="--rows:10"></div></section>
    <section class="col"><h2>Top 20</h2><div id="col-B" class="slots" style="--rows:10"></div></section>
    <section class="col"><h2>Top 10</h2> <div id="col-C" class="slots" style="--rows:7"></div></section>
    <section class="col"><h2>Final Top 3</h2>  <div id="col-D" class="slots" style="--rows:3"></div></section>
    <section class="col"><h2>Banca</h2>  <div id="col-E" class="slots" style="--rows:5"></div></section>
  </div>
  <section class="pool" id="pool">
    <div class="pool-header">
      <h3>Delegadas Disponibles (<span id="pool-count">0</span>)</h3>
      <input type="search" id="search-bar" placeholder="Buscar delegada...">
    </div>
    <div id="cards" class="cards"></div>
  </section>
  <div class="foot">
    <div class="bar">
      <button id="btn-clear" class="btn">Limpiar Todo</button>
      <span class="sep"></span>
      <button id="btn-shuffle" class="btn">Mezclar</button>
      <button id="btn-sort" class="btn">A-Z</button>
      <span class="sep"></span>
      <button id="btn-export" class="btn primary">Exportar Top Final</button>
      <span class="status" id="status-text">Preparado</span>
    </div>
  </div>
</div>
<script>
function setup() { let cnv = createCanvas(windowWidth, windowHeight); cnv.parent('p5-background'); noStroke(); }
function windowResized() { resizeCanvas(windowWidth, windowHeight); }
let particles = [];
function draw() {
  clear(); if (frameCount % 5 === 0) particles.push(new Particle());
  for (let i = particles.length - 1; i >= 0; i--) { particles[i].update(); particles[i].show(); if (particles[i].finished()) particles.splice(i, 1); }
}
class Particle {
  constructor() { this.x = random(width); this.y = height + 50; this.vx = random(-0.5, 0.5); this.vy = random(-0.5, -2); this.alpha = 0; this.d = random(10, 100); }
  finished() { return this.y < -50; }
  update() { this.x += this.vx; this.y += this.vy; if (this.y > height - 100) this.alpha = min(this.alpha + 2, 50); else this.alpha = max(this.alpha - 0.5, 0); }
  show() { fill(255, 215, 0, this.alpha); circle(this.x, this.y, this.d); }
}

(function(){
  let CONTESTANTS = []; // AlmacenarÃ¡ objetos {name, code}
  const RANK_MAP = new Map(); // rank -> {name, code}
  let CURRENT_DRAG = null;
  // --- ACTUALIZADO: RANGOS con la Columna E (Banca) ---
  const RANGES = { 
    A: [30,29,28,27,26,25,24,23,22,21], 
    B: [20,19,18,17,16,15,14,13,12,11], 
    C: [10,9,8,7,6,5,4], 
    D: [3,2,1],
    E: [-1,-2,-3,-4,-5] // Ranks negativos para la banca
  };

  function init() {
    // 1. Crear los slots vacÃ­os
    for (const band in RANGES) {
      const col = document.getElementById(`col-${band}`); col.innerHTML = '';
      RANGES[band].forEach(rank => col.appendChild(createSlotEl(band, rank)));
    }
    
    // 2. Intentar cargar la sesiÃ³n guardada por el usuario
    loadFromStorage();

    // 3. Cargar la lista MAESTRA de delegadas
    fetch('contestants.json').then(r=>r.json()).then(data => {
      // Normalizamos y ordenamos la lista maestra
      CONTESTANTS = data.map(d => typeof d === 'string' ? {name:d, code:''} : d)
                        .sort((a,b) => a.name.localeCompare(b.name));
      
      // 4. LÃ“GICA DE CARGA:
      // Si loadFromStorage() no encontrÃ³ nada (RANK_MAP estÃ¡ vacÃ­o),
      // entonces cargamos el MUTop.json por defecto.
      if (RANK_MAP.size === 0) {
        console.log("No hay sesiÃ³n guardada, cargando MUTop.json por defecto...");
        loadDefaultTop(); // Carga el top por defecto y luego llama a updateUI()
      } else {
        // Si ya habÃ­a una sesiÃ³n, simplemente actualizamos la UI con ella
        console.log("SesiÃ³n cargada desde localStorage.");
        updateUI();
      }
    }).catch(e => { 
      console.error(e); 
      document.getElementById('status-text').textContent = 'Error cargando contestants.json'; 
      updateUI(); // Actualizar de todos modos, aunque sea vacÃ­o
    });
    
    setupGlobalListeners(); 
    setupButtons();
  }

  // --- Carga el top por defecto desde MUTop.json ---
  function loadDefaultTop() {
    fetch('MUTop.json')
      .then(r => r.json())
      .then(defaultTop => {
        // El JSON exportado es un objeto: {"1": "Nombre1", "2": "Nombre2", ...}
        for (const rankStr in defaultTop) {
          const rank = Number(rankStr);
          const name = defaultTop[rankStr];
          
          if (name) {
            // Buscamos la delegada en la lista maestra (CONTESTANTS)
            // para obtener su 'code' (para la bandera)
            const cData = CONTESTANTS.find(c => c.name === name);
            
            if (cData) {
              // Si la encontramos, la aÃ±adimos al RANK_MAP
              RANK_MAP.set(rank, cData);
            } else {
              // Si no se encuentra en contestants.json (por un typo, etc.)
              // la aÃ±adimos solo con el nombre
              console.warn(`Delegada "${name}" de MUTop.json no encontrada en contestants.json.`);
              RANK_MAP.set(rank, { name: name, code: '' });
            }
          }
        }
        // Una vez poblado el RANK_MAP con los datos por defecto,
        // guardamos este estado en localStorage y actualizamos la UI.
        save();
        updateUI();
      })
      .catch(e => {
        console.error("Error al cargar MUTop.json por defecto.", e);
        // Si falla, solo actualizamos la UI (estarÃ¡ vacÃ­a)
        updateUI();
      });
  }

  function flagURL(code) { return code ? `https://flagcdn.com/w40/${code.toLowerCase()}.png` : ''; }

  function createSlotEl(band, rank) {
    const el = document.createElement('div');
    el.className = 'slot'; el.dataset.rank = rank; el.dataset.band = band; el.draggable = true;
    
    let rankDisplay = rank;
    if (band === 'E') rankDisplay = `B${Math.abs(rank)}`; // Display para la Banca: B1, B2...
    else if(rank===1) rankDisplay="ðŸ‘‘"; 
    else if(rank===2) rankDisplay="2Âº"; 
    else if(rank===3) rankDisplay="3Âº";
    
    el.innerHTML = `<div class="num">${rankDisplay}</div><div class="photo"><img alt=""></div><div class="name">â€”</div>`;
    el.addEventListener('dragstart', e => {
      const r = Number(el.dataset.rank); const cData = RANK_MAP.get(r);
      if (!cData) { e.preventDefault(); return; }
      CURRENT_DRAG = { type: 'slot', rank: r, data: cData };
      el.classList.add('ghost'); e.dataTransfer.effectAllowed = 'move';
    });
    el.addEventListener('dragend', () => { el.classList.remove('ghost'); CURRENT_DRAG = null; document.querySelectorAll('.drag-hover').forEach(x => x.classList.remove('drag-hover')); });
    el.addEventListener('dragover', e => { if (!CURRENT_DRAG) return; e.preventDefault(); e.dataTransfer.dropEffect = 'move'; el.classList.add('drag-hover'); });
    el.addEventListener('dragleave', () => el.classList.remove('drag-hover'));
    el.addEventListener('drop', e => {
      e.preventDefault(); el.classList.remove('drag-hover');
      if (!CURRENT_DRAG) return;
      const targetRank = Number(el.dataset.rank);
      if (CURRENT_DRAG.type === 'card') assignRank(CURRENT_DRAG.data, targetRank);
      else if (CURRENT_DRAG.type === 'slot') swapRanks(CURRENT_DRAG.rank, targetRank);
    });
    return el;
  }

  function setupGlobalListeners() {
    const pool = document.getElementById('pool');
    pool.addEventListener('dragover', e => { if (CURRENT_DRAG?.type === 'slot') { e.preventDefault(); pool.classList.add('drag-hover'); } });
    pool.addEventListener('dragleave', () => pool.classList.remove('drag-hover'));
    pool.addEventListener('drop', e => { e.preventDefault(); pool.classList.remove('drag-hover'); if (CURRENT_DRAG?.type === 'slot') unassignRank(CURRENT_DRAG.rank); });
  }

  function assignRank(cData, rank) {
    for (const [r, d] of RANK_MAP.entries()) { if (d.name === cData.name) RANK_MAP.delete(r); }
    RANK_MAP.set(Number(rank), cData); updateUI(); save();
  }
  function swapRanks(r1, r2) {
    const d1 = RANK_MAP.get(r1), d2 = RANK_MAP.get(r2);
    if (d1) RANK_MAP.set(r2, d1); else RANK_MAP.delete(r2);
    if (d2) RANK_MAP.set(r1, d2); else RANK_MAP.delete(r1);
    updateUI(); save();
  }
  function unassignRank(r) { RANK_MAP.delete(Number(r)); updateUI(); save(); }

  function updateUI() {
    document.querySelectorAll('.slot').forEach(slot => {
      const rank = Number(slot.dataset.rank); const cData = RANK_MAP.get(rank);
      const nameEl = slot.querySelector('.name'); const imgEl = slot.querySelector('.photo img');
      if (cData) {
        slot.classList.add('occupied');
        nameEl.innerHTML = `<img class="slot-flag" src="${flagURL(cData.code)}" alt="${cData.code}"> ${cData.name}`;
        if (imgEl) imgEl.src = `photos/${cData.name}.png`;
      } else {
        slot.classList.remove('occupied'); nameEl.textContent = 'â€”';
        if (imgEl) imgEl.removeAttribute('src');
      }
    });
    const cardsEl = document.getElementById('cards'); cardsEl.innerHTML = '';
    const assignedNames = new Set([...RANK_MAP.values()].map(d => d.name));
    CONTESTANTS.filter(c => !assignedNames.has(c.name)).forEach(c => {
      const card = document.createElement('div'); card.className = 'card'; card.draggable = true;
      card.innerHTML = `<img class="card-flag" src="${flagURL(c.code)}" alt="${c.code}"> ${c.name}`;
      card.addEventListener('dragstart', () => { CURRENT_DRAG = { type: 'card', data: c }; card.classList.add('ghost'); });
      card.addEventListener('dragend', () => { card.classList.remove('ghost'); CURRENT_DRAG = null; });
      cardsEl.appendChild(card);
    });
    document.getElementById('pool-count').textContent = CONTESTANTS.length - RANK_MAP.size;
    document.getElementById('status-text').textContent = `${RANK_MAP.size} Top Confirmado`;
    
    // --- NUEVO: Ejecutar filtro de bÃºsqueda ---
    // (Se llama despuÃ©s de construir las cards)
    filterPoolCards();
  }

  // --- NUEVA FUNCIÃ“N: Filtro de BÃºsqueda ---
  function filterPoolCards() {
    const searchTerm = document.getElementById('search-bar').value.toLowerCase();
    const cards = document.getElementById('cards').children;
    let visibleCount = 0;
    
    for (const card of cards) {
      const name = card.textContent.toLowerCase();
      const isVisible = name.includes(searchTerm);
      card.style.display = isVisible ? 'flex' : 'none';
      if (isVisible) visibleCount++;
    }
  }

  function save() { localStorage.setItem('mu_ranks_iso', JSON.stringify([...RANK_MAP])); }
  function loadFromStorage() {
    try {
      const raw = JSON.parse(localStorage.getItem('mu_ranks_iso')||'[]');
      raw.forEach(([r, data]) => {
        // Compatibilidad hacia atrÃ¡s si data era solo un string
        const cData = typeof data === 'string' ? {name: data, code: ''} : data;
        RANK_MAP.set(Number(r), cData);
      });
    } catch(e){}
  }
  
  function setupButtons() {
    // Se elimina el 'confirm()' porque puede ser bloqueado.
    document.getElementById('btn-clear').onclick = () => { 
      console.log('Limpiando el top...');
      RANK_MAP.clear(); 
      updateUI(); 
      save(); 
    };
    document.getElementById('btn-shuffle').onclick = () => { CONTESTANTS.sort(()=>Math.random()-.5); updateUI(); };
    document.getElementById('btn-sort').onclick = () => { CONTESTANTS.sort((a,b)=>a.name.localeCompare(b.name)); updateUI(); };
    document.getElementById('btn-export').onclick = () => {
      // --- ACTUALIZADO: Exportar solo del 1 al 30 ---
      // (La banca con ranks negativos no se incluirÃ¡)
      const d={}; for(let i=1;i<=30;i++) { const data = RANK_MAP.get(i); d[i] = data ? data.name : null; }
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
      a.download='miss_universe_top.json'; a.click();
    };
    
    // --- NUEVO: Listener para la barra de bÃºsqueda ---
    document.getElementById('search-bar').addEventListener('input', filterPoolCards);
  }
  setTimeout(init, 100);
})();
</script>
</body>
</html>